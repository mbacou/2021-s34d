# Vietnam

Field work in Vietnam consisted of a qualitative assessment with focus group discussions and quantitative surveys. We first look at the consolidated survey results.

Notes:   

- 1 Int'l \$ = 7,473.67 VND (Vietnamese Dong) using [2020 World Bank PPP conversion rates](https://data.worldbank.org/indicator/PA.NUS.PPP) (1 Int'l \$ = 1 USD)
- Focus crop = **rice**
- Transportation costs are lumped into the cost of pesticides, fertilizers and harvesting.
- Labor costs are per hectare
- Inspection and certification fees are per farm (total fees for a single season). Only farmers who sell to **seed centers** or **seed companies** do incur these marketing costs.

## Survey Codebook

```{r}

xrate = 7473.67

# Load respondent data
hh <- fread("../data/vnm/hh.csv")
# Load group data
group <- fread("../data/vnm/group.csv")
# Load final codebook
lbl <- fread("../data/vnm/codebook.csv")

```

There are 21 variables and 60 observations in this set. A detailed codebook is shown below.

```{r}
kable(align="llccc", caption="Survey Codebook", lbl) %>%
  kable_def()
```

Recode variable names.

```{r}

setnames(hh, lbl$label, lbl$code, skip_absent=T)

```

Additional recodes for categorical variables. Note that we create a categorical variable `ssd` to indicate whether a farmer currently engages in formal seed system distribution.

```{r}

setorder(hh, adm1_nm, group, gender)

hh[, `:=`(
  hhid = paste("VNM", gsub(" ", "0", format(1:.N, width=3)), sep=""),
  iso3 = "VNM",
  adm1_nm = factor(adm1_nm),
  group = factor(group, levels=hh[, unique(group)]),
  gender = factor(gender, labels=c(Nam="Male", Nữ="Female")),
  ssd = factor(cert_lcu > 0, labels=c("Informal", "Formal"))
)]

```


## Data Enrichment

Below we append some of the information that was recorded at the group level.

```{r}

kbl(group, align="lccccccc") %>%
  kable_def()

# Merge
hh[group, on=.(group=Group), `:=`(
  group_year = `Established`,
  group_size = `Members`,
  soil_type = `Soil`,
  seasons = `Seasons`,
  irrigated = `Irrigation`,
  market_access = `Market access`,
  ttrade = `Transboundary trade`
)]

```


### Spatial Covariates

Using **community GPS coordinates** we also suggest to enrich this dataset with additional biophysical and geospatial variables, e.g.:

- Agroecological zone
- Travel time to nearest market
- Distance to nearest seed center / company
- Size of nearest seed center / company
- Population density
- Last season total rainfall
- Last season heat stress days (if any)

[pending GPS coordinates]


### Constructed Variables

We check farmer-reported total costs `costs_ha_lcu` against the sum of individual cost line items.

```{r}

hh[, 
  tran_ha_lcu := as.numeric(tran_ha_lcu)
][, 
  tran_ha_lcu := fifelse(is.na(tran_ha_lcu), 0, tran_ha_lcu)
][, costs_ha_lcu_imp := 
    # Per ha costs
    seed_ha_lcu + fert_ha_lcu + pest_ha_lcu + tran_ha_lcu + labor_ha_lcu + cert_lcu +
    # Per kg costs
    yield_ha_kg * (labl_kg_lcu + pckg_kg_lcu + mark_kg_lcu)]

hh[, summary(costs_ha_lcu_imp - costs_ha_lcu)]

```

There is no discrepancy between the 2 quantities, so we can assume that total costs are constructed per the formula above. No error was found.

We also check that farmer-reported sales and profit margins are consistent.

```{r}

hh[, summary(sales_ha_lcu - (sales_kg_lcu * sales_ha_kg))]

```

Further we construct gross margin per ha `margin_ha_lcu`, total sales `sales_ha_sh` and profit margin `margin_ha_sh` per unit of (variable) input costs, and `costs_ha_ppp`, `sales_ha_ppp` and `margin_ha_ppp` in PPP terms to allow for comparisons across groups and countries. 

We also construct a measure of **total factor productivity** `tfp` as output per unit of input costs. Strictly speaking it is only "partial factor productivity" here because we don't include the rental cost of land, land preparation costs, irrigation costs, and the costs of animal and mechanical implements.

```{r}

hh[, `:=`(
  margin_ha_lcu = sales_ha_lcu - costs_ha_lcu
)][, `:=`(
  sales_ha_sh = sales_ha_lcu / costs_ha_lcu,
  margin_ha_sh = margin_ha_lcu / costs_ha_lcu,
  costs_ha_ppp = costs_ha_lcu / xrate,
  sales_ha_ppp = sales_ha_lcu / xrate,
  margin_ha_ppp = margin_ha_lcu / xrate
)][, `:=`(
  tfp = yield_ha_kg / costs_ha_ppp
)]

```

Finally we normalize all farmer cost line items into a "long" table `hh_prod_cost` for charting.

```{r}

# Normalize production cost table
hh_prod_cost <- hh[, .(hhid,
  Seeds = seed_ha_lcu, 
  Fertilizer = fert_ha_lcu, 
  Pesticides = pest_ha_lcu, 
  Transport = tran_ha_lcu, 
  Labor = labor_ha_lcu, 
  Certification = cert_lcu,
  Labeling = yield_ha_kg * labl_kg_lcu,
  Packaging = yield_ha_kg * pckg_kg_lcu,
  Marketing = yield_ha_kg * mark_kg_lcu
)]

hh_prod_cost <- melt(hh_prod_cost, id.vars=1, value.name="lcu", variable.name="category")
hh_prod_cost[hh, on=.(hhid), `:=`(
  # Add categories
  group = i.group,
  gender = i.gender,
  ssd = i.ssd
)][, `:=`(
  # Add shares and PPP terms
  share = lcu/sum(lcu, na.rm=T),
  ppp = lcu/xrate
), by=.(hhid)]

```

Note that in the current survey we are missing **farm sizes** (or planted acreage), so we can not directly study the effect of farm size on the per-unit costs of production and yields, or look at potential **scale effects** on a farmer's **efficiency** and **profitability**. We can however study whether larger groups might have positive effects.


## Descriptive Statistics

### Respondent Characteristics

First a breakdown by group.

```{r}

library(ggalluvial)
ggplot(
  hh[, .N, by=.(adm1_nm, group, ssd, gender)],
  aes(axis1=adm1_nm, axis2=gender, axis3=ssd, y=N)) +
  geom_alluvium(aes(fill=group), width=1/4) +
  geom_stratum(width=1/4) +
  geom_text(stat="stratum", aes(label=after_stat(stratum)), angle=90, size=2.2) +
  scale_x_discrete(limits=c("Province", "Gender", "Seed Distribution")) +
  labs(y=NULL, fill="Seed Group",
    title = "Survey Respondents (Vietnam)",
    subtitle = "Stratified by demographics and group membership (N = 60)") +
  theme_def(axis.text=element_text(face="bold"))


```

Showing contingency tables between each pair of categorical variables (seed group, gender, and a farmer's use of formal seed system distribution).

```{r, fig.env="table-condensed"}

library(sjPlot)
sjtab(hh[, .(group, gender)], fun="xtab", var.labels=c("Group", "Gender"),
  show.row.prc=T, show.col.prc=T, show.summary=T, show.exp=T, show.legend=T)

sjtab(hh[, .(gender, ssd)], fun="xtab", var.labels=c("Gender", "Seed System"),
  show.row.prc=T, show.col.prc=T, show.summary=T, show.exp=T, show.legend=T)

```

In the 1st table Chi-square test and p-value < 0 shows that gender and group membership are not independent. In the 2nd table with a Chi-square at zero and a small Cramér’s V (0.033) the variables can be assumed dependent, but that relationship is not significant, as shown also on the mosaic plot below.

```{r, out.width="50%", fig.show="hold", fig.asp=1}

mosaicplot(~gender+ssd, hh, shade=T,
  main = NA,
  xlab="Gender", ylab="Seed System")

mosaicplot(~adm1_nm+ssd, hh, shade=T,
  main = NA,
  xlab="Province", ylab="Seed System")

```

NB. blue means there are more observations in the cell than would be expected under the null model (independence). Red means there are fewer observations than would have been expected.



### Seed Production Costs

We first look at the general breakdown and distribution of input costs across farmer groups and gender.

```{r}

ggplot(hh, aes(gender, costs_ha_ppp, fill=gender)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +
  labs(x="", y="", fill="",
    title="Total Input Costs (PPP$ / ha)",
    subtitle="Stratified by Male vs. Female") +
  theme_def(legend.position="none")

```

```{r}

ggplot(hh, aes(group, costs_ha_ppp, fill=group)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +  
  labs(x="", y="", fill="",
    title="Total Input Costs (PPP$ / ha)",
    subtitle="Stratified by Farmer Group") +
  theme_def(legend.position="none")

```

Breakdown across categories of input.

```{r}

tbl <- hh_prod_cost[, .(
  share = mean(share, na.rm=T)
), keyby=.(gender, ssd, category)]

ggplot(tbl, aes(gender, share, fill=category)) +
  geom_bar(stat="identity", alpha=.8, width=.6) +
  scale_y_continuous(labels=percent) +
  scale_fill_manual("", values=colorRampPalette(pal)(9)) +
  facet_wrap(~ssd) +
  labs(y="", x="",
    title="Breakdown of Input Costs by Gender",
    subtitle="") +
  theme_def()

```

```{r}

tbl <- hh_prod_cost[, .(
  share = mean(share, na.rm=T)
), keyby=.(group, ssd, category)]

ggplot(tbl, aes(group, share, fill=category)) +
  geom_bar(stat="identity", alpha=.8, width=.6) +
  scale_y_continuous(labels=percent) +
  scale_fill_manual("", values=colorRampPalette(pal)(9)) +
  facet_wrap(~ssd, scales="free_x") +
  labs(y="", x="",
    title="Breakdown of Input Costs by Group",
    subtitle="") +
  theme_def()

```

Are there significant differences across groups?

```{r}

ggplot(hh_prod_cost[!category %in% c("Transport", "Marketing")], 
  aes(category, ppp, fill=gender)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +
  labs(x="", y="", fill="",
    title="Input Costs by Category (PPP$ by Hectare)",
    subtitle="Stratified by Male vs. Female") +
  theme_def(legend.position="top")

ggplot(hh_prod_cost[!category %in% c("Transport", "Marketing")], 
  aes(category, ppp, fill=group)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +  
  labs(x="", y="", fill="",
    title="Input Costs by Category (PPP$ by Hectare)",
    subtitle="Stratified by Farmer Group") +
  theme_def(legend.position="top")

```


### Efficiency

Differences in productivity measures across groups?

```{r}

rndr.meansd <- function(x) c(Mean=comma(mean(x, na.rm=T)), SD=comma(sd(x, na.rm=T)))
ttt(yield_ha_kg ~ group | gender, data=hh, render=rndr.meansd,
  caption="Rice Seed Yield (kg / ha)",
  topclass="table-condensed table-striped table-hover")

```

```{r, out.width="50%", fig.width=2.5, fig.show="hold", fig.asp=1}

ggplot(hh, aes(gender, yield_ha_kg, fill=gender)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +
  labs(x="", y="", fill="",
    title="Rice Seed Yield (kg / ha)",
    subtitle="Stratified by Male vs. Female") +
  theme_def(legend.position="none")

ggplot(hh, aes(gender, sales_ha_ppp, fill=gender)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +
  labs(x="", y="", fill="",
    title="Total Seed Sales (PPP$ / ha)",
    subtitle="Stratified by Male vs. Female") +
  theme_def(legend.position="none")

```


```{r}

ggplot(hh, aes(group, yield_ha_kg, fill=group)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +  
  labs(x="", y="", fill="",
    title="Rice Seed Yield (Kg / ha)",
    subtitle="Stratified by Farmer Group") +
  theme_def(legend.position="none")

ggplot(hh, aes(group, sales_ha_ppp, fill=group)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +  
  labs(x="", y="", fill="",
    title="Total Seed Sales (PPP$ / ha)",
    subtitle="Stratified by Farmer Group") +
  theme_def(legend.position="none")

```

Production frontiers across farmer groups and gender (units of output vs. cost units of input). We expect S-shape curves with farmers at different levels of technical efficiency along the curve.

```{r}

ggplot(hh, aes(costs_ha_ppp, yield_ha_kg)) +
  geom_smooth(size=.8) +
  geom_point(alpha=.7, shape=20) +
  scale_x_continuous(labels=comma) +
  scale_y_continuous(labels=comma) +
  coord_cartesian(ylim=c(4000,14000)) +
  labs(x="Costs (PPP$/ha)", y="Yield (kg/ha)",
    title="Production Frontiers (Crop Yield vs. Input Costs)",
    subtitle="Each point is a respondent") +
  theme_def(legend.position="none")

```

```{r}

ggplot(hh, aes(costs_ha_ppp, yield_ha_kg)) +
  geom_smooth(aes(color=gender, fill=gender), size=.8) +
  geom_point(alpha=.7, shape=20) +
  scale_x_continuous(labels=comma) +
  scale_y_continuous(labels=comma) +
  facet_wrap(~gender, scales="free_x") +
  coord_cartesian(ylim=c(4000,14000)) +
  labs(x="Costs (PPP$/ha)", y="Yield (kg/ha)",
    title="Production Frontiers (Crop Yield vs. Input Costs)",
    subtitle="Each point is a respondent") +
  theme_def(legend.position="none")

```

```{r}

ggplot(hh[costs_ha_ppp<4000], aes(costs_ha_ppp, yield_ha_kg)) +
  geom_smooth(aes(color=group, fill=group), size=.8) +
  geom_point(alpha=.7, shape=20) +
  scale_x_continuous(labels=comma) +
  scale_y_continuous(labels=comma) +
  facet_wrap(~group) +
  coord_cartesian(ylim=c(4000,17000)) +
  labs(x="Costs (PPP$/ha)", y="Crop Yield (kg/ha)",
    title="Production Frontiers (Yield vs. Input Costs)",
    subtitle="Each point is a respondent") +
  theme_def(legend.position="none")


```

NB. Removed 1 outlier.


### Profitability

```{r}

rndr.meansd <- function(x) c(Mean=comma(mean(x, na.rm=T)), SD=comma(sd(x, na.rm=T)))
ttt(margin_ha_ppp ~ group | gender, data=hh, render=rndr.meansd,
  caption="Mean Gross Profit Margin in Absolute Terms (PPP$ / ha)",
  topclass="table-condensed table-striped table-hover")

rndr.meansd <- function(x) c(Mean=percent(mean(x, na.rm=T)), SD=percent(sd(x, na.rm=T)))
ttt(margin_ha_sh ~ group | gender, data=hh, render=rndr.meansd,
  caption="Mean Gross Profit Margin in Relative Terms (% of variable input costs)",
  topclass="table-condensed table-striped table-hover")

```

```{r}

ggplot(hh, aes(x=1:nrow(hh), color=group)) +
  geom_linerange(aes(ymin=costs_ha_ppp, ymax=sales_ha_ppp), size=.6) +
  geom_point(aes(y=costs_ha_ppp), shape=20, size=1.4) +
  geom_point(aes(y=sales_ha_ppp), shape=17, size=1.4) +
  scale_y_continuous(labels=comma) +
  labs(x=NULL, y=NULL, color="",
    title="Profit Margin (PPP$ per Hectare)",
    subtitle="Each bar is a respondent") +
  theme_def(legend.position="top")

```

Farmers' gross profit margins by gender and across groups in both absolute terms and in relative terms as percentage of total costs per hectare.

```{r, out.width="50%", fig.width=2.5, fig.show="hold", fig.asp=1}

ggplot(hh, aes(gender, margin_ha_ppp, fill=gender)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +
  facet_wrap(~ssd) +
  labs(x="", y="", fill="",
    title="Gross Profit Margin in Absolute Terms (PPP$ / ha)",
    subtitle="Stratified by Gender") +
  theme_def(legend.position="none")

ggplot(hh, aes(gender, margin_ha_sh, fill=gender)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=percent) +
  facet_wrap(~ssd) +
  labs(x="", y="", fill="",
    title="Gross Profit Margin in Relative Terms (% of variable input costs)",
    subtitle="Stratified by Gender") +
  theme_def(legend.position="none")

```

```{r}

ggplot(hh, aes(group, margin_ha_ppp, fill=group)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +  
  labs(x="", y="", fill="",
    title="Gross Profit Margin in Absolute Terms (PPP$ / ha)",
    subtitle="Stratified by Farmer Group") +
  theme_def(legend.position="none")

```

```{r}

ggplot(hh, aes(group, margin_ha_sh, fill=group)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=percent) +  
  labs(x="", y="", fill="",
    title="Gross Profit Margin in Relative Terms (% of variable input costs)",
    subtitle="Stratified by Farmer Group") +
  theme_def(legend.position="none")

```

### Clustering

[TBD]



```{r save-vnm}

rm(tmp, x, y, i)
save.image("../tmp/data_vnm.RData")

```

