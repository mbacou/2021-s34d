# Niger

Notes: 

- 1 Int'l \$ = 257.60 XOF (CFA) using [2020 World Bank PPP conversion rates](https://data.worldbank.org/indicator/PA.NUS.PPP) (1 Int'l \$ = 1 USD)
- Focus crop = **cowpea** and **millet**
- All costs are reported per hectare. Inspection, certification and other marketing costs are assumed for the entire farm. Labeling and packaging are per kg.
- Some farmers grow multiple crops


## Survey Recodes

```{r nge}

xrate <- 257.60

# Load respondent data
hh <- fread("../data/nre/hh.csv")
group <- fread("../data/nre/group.csv")

```

There are `r ncol(hh)` variables and `r nrow(hh)` observations in this set. A summary is shown below.

```{r, results="asis"}

print(dfSummary(hh),
  max.tbl.height=500, table.classes="table-condensed", method="render")

```

Recode variable names.

```{r}

setnames(hh, lbl$label, lbl$code, skip_absent=T)

```

Additional recodes for categorical variables.

```{r}

setorder(hh, adm2_nm, adm3_nm, group, gender, crop)

hh[, `:=`(
  hhid = paste("NRE", gsub(" ", "0", format(1:.N, width=3)), sep=""),
  iso3 = "NRE",
  adm2_nm = factor(adm2_nm),
  adm3_nm = factor(adm3_nm),
  group = factor(group, levels=c(
    "Boukassa_Noma",
    "Cigaban_Matta",
    "Yada_Iri",
    "HIMMA"
  ), labels=c(
    "Boukassa Noma",
    "Cigaban Matta",
    "Yada Iri",
    "Himma"    
  )),
  gender = factor(gender, levels=c("male", "female"), labels=c("Male", "Female")),
  age = factor(age, levels=c("15-29", "30+"), labels=c("< 30", "â‰¥ 30")),
  crop = factor(crop)
)]

```


### Constructed Variables

Farmers report both expected yields `yield_ha_kg` and sales in the last season `sales_ha_kg`, so we can construct both **expected** and **realized** costs in monetary terms `costs_exp_ha_lcu` and `costs_real_ha_lcu`. Note that we then use **realized** yields to calculate profitability metrics.

```{r}

hh[, 
  tran_ha_lcu := as.numeric(tran_ha_lcu)
][, 
  tran_ha_lcu := fifelse(is.na(tran_ha_lcu), 0, tran_ha_lcu)
][, `:=`(
  # Expected costs
  costs_exp_ha_lcu = 
    # Per ha costs
    seed_ha_lcu + fert_ha_lcu + pest_ha_lcu + tran_ha_lcu + labor_ha_lcu + 
    cert_lcu + mark_kg_lcu +
    # Per kg costs
    yield_ha_kg * (labl_kg_lcu + pckg_kg_lcu),  
  
  # Realized costs
  costs_real_ha_lcu = 
    # Per ha costs
    seed_ha_lcu + fert_ha_lcu + pest_ha_lcu + tran_ha_lcu + labor_ha_lcu + 
    cert_lcu + mark_kg_lcu +
    # Per kg costs
    sales_ha_kg * (labl_kg_lcu + pckg_kg_lcu)
)]

hh[, summary(costs_real_ha_lcu)]

```

Using **realized** costs and sales, we construct gross margin per ha `margin_ha_lcu`, total sales `sales_ha_sh` and profit margin `margin_ha_sh` per unit of (variable) input costs, and `costs_ha_ppp`, `sales_ha_ppp` and `margin_ha_ppp` in PPP terms to allow for comparisons across groups and countries. 

We also construct a measure of **total factor productivity** `tfp` as **expected** output per unit of (expected) input costs. Strictly speaking it is only "partial factor productivity" here because we don't include the rental cost of land, land preparation costs, irrigation costs, and the costs of animal and mechanical implements.

```{r}

hh[, `:=`(
  sales_exp_ha_lcu = yield_ha_kg * sales_kg_lcu,
  sales_real_ha_lcu = sales_ha_kg * sales_kg_lcu
)][, `:=`(
  margin_ha_lcu = sales_real_ha_lcu - costs_real_ha_lcu
)][, `:=`(
  sales_ha_sh = sales_real_ha_lcu / costs_real_ha_lcu,
  margin_ha_sh = margin_ha_lcu / costs_real_ha_lcu,
  costs_ha_ppp = costs_real_ha_lcu / xrate,
  sales_ha_ppp = sales_real_ha_lcu / xrate,
  margin_ha_ppp = margin_ha_lcu / xrate
)][, `:=`(
  tfp = yield_ha_kg / (costs_exp_ha_lcu / xrate)
)]

```

Note that 6 respondents indicate no sales (and hence a negative gross nargin) this past season (crop failure or decision not to sell):

```{r}

kbl(hh[sales_ha_kg==0, .(
  hhid, group, crop, 
  sales_exp_ha_lcu, sales_real_ha_lcu, margin_ha_lcu, yield_ha_kg)],
  format.args=list(big.mark=","))

```

Below we append some of the information that was recorded at the group level.

```{r}

# Same recodes in the group-level dataset
group[, Group := factor(Group, levels=c(
  "Boukassa Noma",
  "Cigaban Matta",
  "Yada Iri",
  "HIMMA"
), labels=c(
  "Boukassa Noma",
  "Cigaban Matta",
  "Yada Iri",
  "Himma"    
))]

# Merge
hh[group, on=.(group=Group), `:=`(
  group_year = `Established`,
  group_size = `Members`,
  seasons = `Seasons`,
  irrigated = `Irrigation`,
  market_access = `Market access`,
  ttrade = `Transboundary trade`
)]

kbl(group, align="lllllc")

```

Finally we normalize all cost line items into a "long" table `hh_prod_cost` for charting. Again we use **realized** costs here.

```{r}

# Normalize production cost table per ha
hh_prod_cost <- hh[, .(hhid,
  Seeds = seed_ha_lcu, 
  Fertilizer = fert_ha_lcu, 
  Pesticides = pest_ha_lcu, 
  Transport = tran_ha_lcu, 
  Labor = labor_ha_lcu, 
  Certification = cert_lcu,
  Labeling = sales_ha_kg * labl_kg_lcu,
  Packaging = sales_ha_kg * pckg_kg_lcu,
  Marketing = mark_kg_lcu
)]

hh_prod_cost <- melt(hh_prod_cost, id.vars=1, value.name="lcu", variable.name="type")

```

And we lump all marketing costs into a single category.

```{r}

hh_prod_cost[, type_alt := factor(as.character(type), labels=c(
  Seeds = "Seeds",
  Fertilizer = "Fertilizer",
  Pesticides = "Pesticides",
  Labor = "Labor",
  Certification = "Marketing",
  Transport = "Marketing",
  Labeling = "Marketing",
  Packaging = "Marketing",
  Marketing = "Marketing"
))]

hh_prod_cost <- hh_prod_cost[, .(
  lcu = sum(lcu, na.rm=T)
), by=.(hhid, type=type_alt)
][, `:=`(
  # Add cost shares and PPP terms
  share = lcu/sum(lcu, na.rm=T),
  ppp = lcu/xrate
), by=.(hhid)
][hh, on=.(hhid), `:=`(
  # Add classes
  group = group,
  gender = gender,
  age = age,
  crop = crop
)]

```

## Descriptive Statistics

### Respondent Characteristics

First a breakdown by group.

```{r, fig.height=4}

ggplot(
  hh[, .N, by=.(group, age, gender, crop)],
  aes(axis1=gender, axis2=age, axis3=crop, y=N)) +
  geom_alluvium(aes(fill=group), width=1/4, alpha=.7, color="white") +
  geom_stratum(width=1/4) +
  geom_text(stat="stratum", aes(label=after_stat(stratum)), angle=90, size=2.2) +
  scale_x_discrete(limits=c("Gender", "Age", "Crop")) +
  labs(y=NULL, fill="Seed Club",
    title = "Survey Respondents (Niger)",
    subtitle = "Stratified by club and demographics") +
  theme_def(axis.text=element_text(face="bold"))


```

Showing contingency table between each pair of categorical variables (seed club `group`, `gender`, and age `age`).

```{r, results="asis"}

print(ctable(hh$group, hh$gender, chisq=T, round.digits=0, 
  dnn=c("Group", "Gender")), 
  table.classes="table-condensed", method="render")
print(ctable(hh$group, hh$age, chisq=T, round.digits=0, 
  dnn=c("Group", "Age")),
  table.classes="table-condensed", method="render")

```


### Seed Production Costs

General breakdown and distribution of input costs across seed clubs, crop, gender, and input type.

Note that HIMMA group grows both **cowpea** and **millet**.

```{r}

ttt(costs_ha_ppp ~ group | gender, data=hh, render=fmt,
  caption="Total Input Costs in Absolute Terms (PPP$ / ha) - Niger")

```

```{r, out.width="50%", fig.show="hold", fig.width=2.5, fig.asp=1}

ggplot(hh, aes(gender, costs_ha_ppp, fill=gender)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +
  facet_wrap(~crop) +
  labs(x="", y="", fill="",
    title="Total Input Costs (PPP$ / ha) - Niger",
    subtitle="Stratified by crop and gender") +
  theme_def(legend.position="none")

ggplot(hh, aes(sub(" ", "\n", group), costs_ha_ppp, fill=group)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +  
  facet_wrap(~crop, scales="free_x") +
  labs(x="", y="", fill="",
    title="Total Input Costs (PPP$ / ha) - Niger",
    subtitle="Stratified by crop and seed club") +
  theme_def(legend.position="none")

```

Breakdown across categories of farm input.

```{r}

ttt(ppp ~ type | gender+crop, data=hh_prod_cost, render=fmt,
  caption="Input Costs in Absolute Terms by Gender (PPP$ / ha) - Niger")

ttt(ppp ~ type | group, data=hh_prod_cost, render=fmt,
  caption="Input Costs in Absolute Terms by Seed Group (PPP$ / ha) - Niger")

```

```{r}

tbl <- hh_prod_cost[, .(
  ppp = mean(ppp, na.rm=T)
), keyby=.(gender, crop, type)]

ggplot(tbl, aes(gender, ppp, fill=type)) +
  geom_bar(stat="identity", position="fill", alpha=.7, width=.6, color="white") +
  scale_y_continuous(labels=percent) +
  scale_fill_manual("", values=colorRampPalette(pal)(5)) +
  facet_wrap(~crop) +
  labs(y="", x="",
    title="Breakdown of Input Costs by Category - Niger",
    subtitle="Stratified by crop and gender") +
  theme_def()

```

```{r}

tbl <- hh_prod_cost[, .(
  ppp = mean(ppp, na.rm=T)
), keyby=.(group, crop, type)]

ggplot(tbl, aes(group, ppp, fill=type)) +
  geom_bar(stat="identity", position="fill", alpha=.7, width=.6, color="white") +
  scale_y_continuous(labels=percent) +
  scale_fill_manual("", values=colorRampPalette(pal)(5)) +
  facet_wrap(~crop, scales="free_x") +
  labs(y="", x="",
    title="Breakdown of Input Costs by Category - Niger",
    subtitle="Stratified by seed club") +
  theme_def()

```

Are there significant differences across groups? We first compare input cost shares across gender, then across seed clubs.

```{r}

ggplot(hh_prod_cost[!type %in% c("Seeds")], 
  aes(type, share, fill=gender)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=percent) +
  coord_flip() +
  facet_wrap(~crop, scales="free_x") +  
  labs(x="", y="", fill="",
    title="Input Costs by Category (Percent of Total Costs by Ha) - Niger",
    subtitle="Stratified by gender") +
  theme_def(legend.position="top")

```

```{r}

ggplot(hh_prod_cost[!type %in% c("Seeds")], 
  aes(type, share, fill=group)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=percent) +  
  coord_flip() +
  facet_wrap(~crop, scales="free_x") +  
  labs(x="", y="", fill="",
    title="Input Costs by Category (PPP$ by Hectare) - Niger",
    subtitle="Stratified by seed club") +
  theme_def(legend.position="top")

```


### Efficiency

Differences in productivity measures (expected yields and sales) across groups?

```{r}

ttt(yield_ha_kg ~ group+crop | gender, data=hh, render=fmt,
  caption="Expected Seed Yield (kg / ha) - Niger")


ttt(sales_ha_kg ~ group+crop | gender, data=hh, render=fmt,
  caption="Realized Seed Sales (kg / ha) - Niger")

```

Across age groups?

```{r}

ttt(yield_ha_kg ~ group | age, data=hh, render=fmt,
  caption="Seed Yield (kg / ha) - Niger")

ttt(sales_ha_kg ~ group+crop | age, data=hh, render=fmt,
  caption="Realized Seed Sales (kg / ha) - Niger")

```

```{r, out.width="50%", fig.width=2.5, fig.show="hold", fig.asp=1}

ggplot(hh, aes(gender, yield_ha_kg, fill=gender)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +
  facet_wrap(~crop, scales="free_y") +  
  labs(x="", y="", fill="",
    title="Expected Seed Yield (kg / ha) - Niger",
    subtitle="Stratified by gender") +
  theme_def(legend.position="none")

ggplot(hh, aes(gender, sales_ha_ppp, fill=gender)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +
  facet_wrap(~crop, scales="free_y") +  
  labs(x="", y="", fill="",
    title="Total Seed Sales (PPP$ / ha) - Niger",
    subtitle="Stratified by gender") +
  theme_def(legend.position="none")

```


```{r, out.width="50%", fig.width=2.5, fig.show="hold", fig.asp=1}

ggplot(hh, aes(group, yield_ha_kg, fill=group)) +
  geom_boxplot(alpha=.7) +
  scale_x_discrete(labels=label_wrap(5)) +
  scale_y_continuous(labels=comma) +
  facet_wrap(~crop, scales="free") +
  labs(x="", y="", fill="",
    title="Expected Seed Yield (Kg / ha) - Niger",
    subtitle="Stratified by seed club") +
  theme_def(legend.position="none")

ggplot(hh, aes(group, sales_ha_ppp, fill=group)) +
  geom_boxplot(alpha=.7) +
  scale_x_discrete(labels=label_wrap(5)) +
  scale_y_continuous(labels=comma) +
  facet_wrap(~crop, scales="free") +
  labs(x="", y="", fill="",
    title="Total Seed Sales (PPP$ / ha) - Niger",
    subtitle="Stratified by seed club") +
  theme_def(legend.position="none")

```

Looking at **production frontiers** (units of output vs. units of input). We expect S-shape curves with farmers at different levels of technical efficiency along the curve. 

```{r}

outlier <- hh[crop=="millet" & costs_ha_ppp > 2000, hhid]

ggplot(hh[!hhid %in% outlier], aes(costs_ha_ppp, yield_ha_kg)) +
  geom_smooth(size=.8) +
  geom_point(alpha=.7, shape=20, color=1) +
  geom_point(data=hh[hhid %in% outlier], aes(costs_ha_ppp, yield_ha_kg), 
    alpha=.7, color=2, shape=18) +
  scale_x_continuous(labels=comma) +
  scale_y_continuous(labels=comma) +
  facet_wrap(~crop, scales="free") +
  labs(x="", y="",
    title="Production Frontier (Output vs. Input) - Niger",
    subtitle="Each point is a respondent (kg vs. PPP$ / ha)") +
  theme_def(legend.position="none")

```

```{r}

ggplot(hh[!hhid %in% outlier], aes(costs_ha_ppp, yield_ha_kg)) +
  geom_smooth(aes(color=gender, fill=gender), size=.8, level=.9) +
  geom_point(alpha=.7, shape=20) +
  scale_x_continuous(labels=comma) +
  scale_y_continuous(labels=comma) +
  facet_wrap(~crop, scales="free") +
  #coord_cartesian(xlim=c(0, 2000)) +
  labs(x="", y="",
    title="Production Frontier (Output vs. Input) - Niger",
    subtitle="Each point is a respondent. Shade shows 90% CI (kg vs. PPP$ / ha)") +
  theme_def(legend.position="right")

```


### Profitability

By gender:

```{r}

ttt(margin_ha_ppp ~ group+crop | gender, data=hh, render=fmt,
  caption="Mean Gross Profit Margin in Absolute Terms (PPP$ / ha) - Niger")

ttt(margin_ha_sh ~ group+crop | gender, data=hh, render=fmt_pct,
  caption="Mean Gross Profit Margin in Relative Terms (% of variable input costs) - Niger")

```

By age group:

```{r}

ttt(margin_ha_ppp ~ group+crop | age, data=hh, render=fmt,
  caption="Mean Gross Profit Margin in Absolute Terms (PPP$ / ha) - Niger")

ttt(margin_ha_sh ~ group+crop | age, data=hh, render=fmt_pct,
  caption="Mean Gross Profit Margin in Relative Terms (% of variable input costs) - Niger")

```

```{r}

ggplot(hh, aes(x=1:nrow(hh), color=group)) +
  geom_linerange(aes(ymin=costs_ha_ppp, ymax=sales_ha_ppp), size=.6) +
  geom_point(aes(y=costs_ha_ppp), shape=20, size=1.4) +
  geom_point(aes(y=sales_ha_ppp, shape=margin_ha_ppp>0, fill=group), size=1.4) +
  scale_y_continuous(labels=comma) +
  scale_shape_manual(values=c(25, 24)) +
  guides(shape=F, fill=F) +
  labs(x=NULL, y=NULL, color="", linetype="",
    title="Profit Margin (PPP$ / ha) - Niger",
    subtitle="Each bar is a respondent's gross profit margin") +
  theme_def(legend.position="right")

```

Farmers' gross profit margins by gender and across groups in both absolute terms and in relative terms (percentage of total costs per hectare).

```{r, out.width="50%", fig.width=2.5, fig.show="hold", fig.asp=1}

ggplot(hh, aes(gender, margin_ha_ppp, fill=gender)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +
  facet_wrap(~crop) +
  labs(x="", y="", fill="",
    title="Gross Profit Margin in Absolute Terms - Niger",
    subtitle="Stratified by gender (PPP$ / ha)") +
  theme_def(legend.position="none")

ggplot(hh, aes(gender, margin_ha_sh, fill=gender)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=percent) +
  facet_wrap(~crop) +
  labs(x="", y="", fill="",
    title="Gross Profit Margin in Relative Terms - Niger",
    subtitle="Stratified by gender (% of total costs)") +
  theme_def(legend.position="none")

```

```{r, out.width="50%", fig.width=2.5, fig.show="hold", fig.asp=1}

ggplot(hh, aes(group, margin_ha_ppp, fill=group)) +
  geom_boxplot(alpha=.7) +
  scale_x_discrete(labels=label_wrap(5)) +
  scale_y_continuous(labels=comma) +  
  labs(x="", y="", fill="",
    title="Gross Profit Margin in Absolute Terms",
    subtitle="Stratified by seed club (PPP$ / ha)") +
  theme_def(legend.position="none")

ggplot(hh, aes(group, margin_ha_sh, fill=group)) +
  geom_boxplot(alpha=.7) +
  scale_x_discrete(labels=label_wrap(5)) +  
  scale_y_continuous(labels=percent) +  
  labs(x="", y="", fill="",
    title="Gross Profit Margin in Relative Terms - Niger",
    subtitle="Stratified by seed club (% of total costs)") +
  theme_def(legend.position="none")

```

## Correlation

Significant associations. 

```{r, fig.height=5}

ggpairs(
  hh[, .(`seed club`=sub(" ", "\n", group), 
    `age`=age_num, `years in group`=member_years,
    `costs PPP$`=costs_ha_ppp, `seed yield kg/ha`=yield_ha_kg,
    `margin PPP$`=margin_ha_ppp, `margin %`=margin_ha_sh)],
  upper = list(
    continuous="cor", 
    combo=wrap("summarise_by", color=pal[1:4], size=2)),
  lower = list(
    continuous=wrap("smooth", shape=NA), 
    combo=wrap("box_no_facet", fill=pal[1:4], alpha=.8)),
  diag = list(
    continuous=wrap("densityDiag", fill=NA),
    discrete=wrap("barDiag", fill=pal[1:4], alpha=.8)),
  title="Correlogram stratified by seed club - Niger"
) + 
  theme_def(
    strip.text=element_text(hjust=.5),
    panel.grid.major=element_blank()
  )

```

```{r, fig.height=5}

ggpairs(
  hh[, .(gender, `age`=age_num, `years in group`=member_years, 
    `costs PPP$`=costs_ha_ppp, `seed yield kg/ha`=yield_ha_kg, 
    `margin PPP$`=margin_ha_ppp, `margin %`=margin_ha_sh)],
  upper = list(
    continuous="cor", 
    combo=wrap("summarise_by", color=pal[1:2], size=2)),
  lower = list(
    continuous=wrap("smooth", shape=NA, color=hh[, pal[gender]]), 
    combo=wrap("box_no_facet", fill=pal[1:2], alpha=.8)),
  diag = list(
    continuous=wrap("densityDiag", fill=NA),
    discrete=wrap("barDiag", fill=pal[1:2], alpha=.8)),
  title="Correlogram stratified by gender - Niger"
) +   
  theme_def(
    strip.text=element_text(hjust=.5),
    panel.grid.major=element_blank()
  )

```

```{r save-nre}

saveRDS(hh, "../tmp/data_nre.rds")

```

