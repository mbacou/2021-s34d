# Guatemala

Notes:   

- 1 Int'l \$ = 4.01 GTQ (Quetzal) using [2020 World Bank PPP conversion rates](https://data.worldbank.org/indicator/PA.NUS.PPP) (1 Int'l \$ = 1 USD)
- All costs are reported per hectare, except for labeling and packaging costs (per bag of 3 pounds or 1.36 kg). Other marketing costs are assumed also per hectare
- Inspection and certification fees are per farm (total fees for a single season)
- Some farmers grow multiple crops


## Survey Codebook

```{r}

xrate <- 4.01

# Load respondent data
hh <- fread("../data/gtm/hh.csv")
# Load complete codebook
lbl <- fread("../data/codebook.csv")

```

There are `r ncol(hh)` variables and `r nrow(hh)` observations in this set. A detailed codebook is shown below.

```{r}

kbl(lbl[label %in% names(hh)], align="llccc", caption="Survey Codebook")

```

Recode variable names.

```{r}

setnames(hh, lbl$label, lbl$code, skip_absent=T)

```

Additional recodes for categorical variables.

```{r}

setorder(hh, adm1_nm, group, gender, crop)

hh[, `:=`(
  hhid = paste("GTM", gsub(" ", "0", format(1:.N, width=3)), sep=""),
  iso3 = "GTM",
  adm1_nm = factor(adm1_nm),
  group = factor(group, labels=c(
    `ACORDI` = "Acordi",
    `PAQUIX` = "Paquix",
    `SAN BARTOLO` = "San Bartolo",
    `ADAT, AXOLA, ADIPY` = "Adat Axola Adipy"
  )),
  gender = factor(gender, labels=c(Male="Male", Female="Female")),
  age = factor(age, labels=c(`15-29`="< 30", `30`="â‰¥ 30"))
)]

```


### Spatial Covariates

Using **community GPS coordinates** we also suggest to enrich this dataset with additional biophysical and geospatial variables, e.g.:

- Agroecological zone
- Travel time to nearest market
- Distance to nearest seed center / company
- Size of nearest seed center / company
- Population density
- Last season total rainfall
- Last season heat stress days (if any)

[pending GPS coordinates]


### Constructed Variables

We construct **total costs per ha** `costs_ha_lcu` as the sum of individual cost line items.

```{r}

hh[, 
  tran_ha_lcu := as.numeric(tran_ha_lcu)
][, 
  tran_ha_lcu := fifelse(is.na(tran_ha_lcu), 0, tran_ha_lcu)
][, costs_ha_lcu := 
    # Per ha costs
    seed_ha_lcu + fert_ha_lcu + pest_ha_lcu + tran_ha_lcu + labor_ha_lcu + cert_lcu + mark_kg_lcu +
    # Per kg costs
    yield_ha_kg * (1/1.36) * (labl_kg_lcu + pckg_kg_lcu)]

hh[, summary(costs_ha_lcu)]

```

We also construct **total sales per ha** `sales_ha_lcu`.

```{r}

hh[, sales_ha_lcu := sales_kg_lcu * sales_ha_kg]

```

Further we construct gross margin per ha `margin_ha_lcu`, total sales `sales_ha_sh` and profit margin `margin_ha_sh` per unit of (variable) input costs, and `costs_ha_ppp`, `sales_ha_ppp` and `margin_ha_ppp` in PPP terms to allow for comparisons across groups and countries. 

We also construct a measure of **total factor productivity** `tfp` as output per unit of input costs. Strictly speaking it is only "partial factor productivity" here because we don't include the rental cost of land, land preparation costs, irrigation costs, and the costs of animal and mechanical implements.

```{r}

hh[, `:=`(
  margin_ha_lcu = sales_ha_lcu - costs_ha_lcu
)][, `:=`(
  sales_ha_sh = sales_ha_lcu / costs_ha_lcu,
  margin_ha_sh = margin_ha_lcu / costs_ha_lcu,
  costs_ha_ppp = costs_ha_lcu / xrate,
  sales_ha_ppp = sales_ha_lcu / xrate,
  margin_ha_ppp = margin_ha_lcu / xrate
)][, `:=`(
  tfp = yield_ha_kg / costs_ha_ppp
)]

```

Finally we normalize all farmer cost line items into a "long" table `hh_prod_cost` for charting.

```{r}

# Normalize production cost table
hh_prod_cost <- hh[, .(hhid,
  Seeds = seed_ha_lcu, 
  Fertilizer = fert_ha_lcu, 
  Pesticides = pest_ha_lcu, 
  Transport = tran_ha_lcu, 
  Labor = labor_ha_lcu, 
  Certification = cert_lcu,
  Labeling = yield_ha_kg * (1/1.36) * labl_kg_lcu,
  Packaging = yield_ha_kg * (1/1.36) * pckg_kg_lcu,
  Marketing = mark_kg_lcu
)]

hh_prod_cost <- melt(hh_prod_cost, id.vars=1, value.name="lcu", variable.name="type")
hh_prod_cost[hh, on=.(hhid), `:=`(
  # Add categorical vars
  group = i.group,
  gender = i.gender,
  age = i.age,
  crop = i.crop
)][, `:=`(
  # Add cost shares and PPP terms
  share = lcu/sum(lcu, na.rm=T),
  ppp = lcu/xrate
), by=.(hhid)]

```

## Descriptive Statistics

### Respondent Characteristics

First a breakdown by group.

```{r, fig.height=3.5}

ggplot(
  hh[, .N, by=.(adm1_nm, group, age, gender, crop)],
  aes(axis1=gender, axis2=age, axis3=crop, y=N)) +
  geom_alluvium(aes(fill=group), width=1/4) +
  geom_stratum(width=1/4) +
  geom_text(stat="stratum", aes(label=after_stat(stratum)), angle=90, size=2.2) +
  scale_x_discrete(limits=c("Gender", "Age", "Crop")) +
  labs(y=NULL, fill="Seed Club",
    title = "Survey Respondents (Guatemala)",
    subtitle = "Stratified by club and demographics") +
  theme_def(axis.text=element_text(face="bold"))


```

Showing contingency table between each pair of categorical variables (seed club `group`, `gender`, and age `age`).

```{r}

ttt_ftable(hh, vars=c("group", "gender", "age"))

```

Mantel-Haenszel test shows weak association between the 3 variables. This is further shown in the 2x2 mosaic plots below (standardized residuals between [-2,2]).

```{r, out.width="50%", fig.show="hold", fig.asp=1}

mosaicplot(~gender+age, hh, shade=T,
  main=NA, xlab="Gender", ylab="Age")

mosaicplot(~group+age, hh, shade=T,
  main=NA, xlab="Province", ylab="Age")

```

NB. blue means there are more observations in the cell than would be expected under the null model (independence). Red means there are fewer observations than would have been expected.



### Seed Production Costs

We then look at the general breakdown and distribution of input costs across seed clubs, crop, gender, and input type.

Note that Acordi and Paquix grow potato, while San Bartolo and Adapt grow bean.

```{r}

ggplot(hh, aes(gender, costs_ha_ppp, fill=gender)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +
  facet_wrap(~crop, scales="free") +
  labs(x="", y="", fill="",
    title="Total Input Costs (PPP$ / ha) - Guatemala",
    subtitle="Stratified by gender and crop type") +
  theme_def(legend.position="none")

ggplot(hh, aes(group, costs_ha_ppp, fill=group)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +
  facet_wrap(~crop, scales="free") +  
  labs(x="", y="", fill="",
    title="Total Input Costs (PPP$ / ha) - Guatemala",
    subtitle="Stratified by seed club and crop type") +
  theme_def(legend.position="none")

```

Breakdown across categories of farm input.

```{r}

tbl <- hh_prod_cost[, .(
  share = mean(share, na.rm=T)
), keyby=.(crop, gender, type)]

ggplot(tbl, aes(gender, share, fill=type)) +
  geom_bar(stat="identity", alpha=.8, width=.6) +
  scale_y_continuous(labels=percent) +
  scale_fill_manual("", values=colorRampPalette(pal)(9)) +
  facet_wrap(~crop) +
  labs(y="", x="",
    title="Breakdown of Input Costs by Category - Guatemala",
    subtitle="Stratified by gender and crop types") +
  theme_def()

```

```{r}

tbl <- hh_prod_cost[, .(
  share = mean(share, na.rm=T)
), keyby=.(group, crop, type)]

ggplot(tbl, aes(group, share, fill=type)) +
  geom_bar(stat="identity", alpha=.8, width=.6) +
  scale_y_continuous(labels=percent) +
  scale_fill_manual("", values=colorRampPalette(pal)(9)) +
  facet_wrap(~crop, scales="free_x") +
  labs(y="", x="",
    title="Breakdown of Input Costs by Category - Guatemala",
    subtitle="Stratified by seed club and crop type") +
  theme_def()

```

Are there significant differences across groups?

```{r, fig.height=4}

ggplot(hh_prod_cost, 
  aes(type, ppp, fill=gender)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +
  coord_flip() +
  facet_wrap(~crop, scales="free_x") +  
  labs(x="", y="", fill="",
    title="Input Costs by Category (PPP$ by Hectare) - Guatemala",
    subtitle="Stratified by gender and crop type") +
  theme_def(legend.position="top")

ggplot(hh_prod_cost, 
  aes(type, ppp, fill=group)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +
  coord_flip() +
  facet_wrap(~crop, scales="free_x") +
  labs(x="", y="", fill="",
    title="Input Costs by Category (PPP$ by Hectare) - Guatemala",
    subtitle="Stratified by seed club and crop type") +
  theme_def(legend.position="top")

```


### Efficiency

Differences in productivity measures across groups?

```{r}

fmt <- function(x) c(Mean=comma(mean(x, na.rm=T)), SD=comma(sd(x, na.rm=T)))
ttt(yield_ha_kg ~ group | gender, data=hh, render=fmt,
  caption="Seed Yield (kg / ha) - Guatemala")

```

```{r}

fmt <- function(x) c(Mean=comma(mean(x, na.rm=T)), SD=comma(sd(x, na.rm=T)))
ttt(yield_ha_kg ~ group | age, data=hh, render=fmt,
  caption="Seed Yield (kg / ha) - Guatemala")

```

```{r}

ggplot(hh, aes(gender, yield_ha_kg, fill=gender)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +
  facet_wrap(~crop, scales="free_y") +  
  labs(x="", y="", fill="",
    title="Seed Yield (kg / ha) - Guatemala",
    subtitle="Stratified by gender") +
  theme_def(legend.position="none")

ggplot(hh, aes(gender, sales_ha_ppp, fill=gender)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +
  facet_wrap(~crop, scales="free_y") +  
  labs(x="", y="", fill="",
    title="Total Seed Sales (PPP$ / ha) - Guatemala",
    subtitle="Stratified by gender") +
  theme_def(legend.position="none")

```


```{r}

ggplot(hh, aes(group, yield_ha_kg, fill=group)) +
  geom_boxplot(alpha=.7) +
  scale_x_discrete(labels=label_wrap(5)) +
  scale_y_continuous(labels=comma) +
  facet_wrap(~crop, scales="free") +
  labs(x="", y="", fill="",
    title="Seed Yield (Kg / ha) - Guatemala",
    subtitle="Stratified by seed club") +
  theme_def(legend.position="none")

ggplot(hh, aes(group, sales_ha_ppp, fill=group)) +
  geom_boxplot(alpha=.7) +
  scale_x_discrete(labels=label_wrap(5)) +
  scale_y_continuous(labels=comma) +
  facet_wrap(~crop, scales="free") +
  labs(x="", y="", fill="",
    title="Total Seed Sales (PPP$ / ha) - Guatemala",
    subtitle="Stratified by seed club") +
  theme_def(legend.position="none")

```

Looking at **production frontiers** (units of output vs. units of input). We expect S-shape curves with farmers at different levels of technical efficiency along the curve. 

```{r}

outlier <- ""

ggplot(hh[!hhid %in% outlier], aes(costs_ha_ppp, yield_ha_kg)) +
  geom_smooth(size=.8) +
  geom_point(alpha=.7, shape=20, color=1) +
  geom_point(data=hh[hhid %in% outlier], aes(costs_ha_ppp, yield_ha_kg), 
    alpha=.7, color=2, shape=18) +
  scale_x_continuous(labels=comma) +
  scale_y_continuous(labels=comma) +
  facet_wrap(~crop, scales="free") +
  #coord_cartesian(ylim=c(4000, 14000)) +
  labs(x="", y="",
    title="Production Frontier (Output vs. Input) - Guatemala",
    subtitle="Each point is a respondent (kg vs. PPP$ / ha)") +
  theme_def(legend.position="none")

```

```{r}

ggplot(hh[!hhid %in% outlier], aes(costs_ha_ppp, yield_ha_kg)) +
  geom_smooth(aes(color=gender, fill=gender), size=.8, level=.9) +
  geom_point(alpha=.7, shape=20) +
  scale_x_continuous(labels=comma) +
  scale_y_continuous(labels=comma) +
  facet_wrap(~crop, scales="free") +
  #coord_cartesian(ylim=c(4000, 14000)) +
  labs(x="", y="",
    title="Production Frontier (Output vs. Input) - Guatemala",
    subtitle="Each point is a respondent. Shade shows 90% CI (kg vs. PPP$ / ha)") +
  theme_def(legend.position="right")

```

```{r}

ggplot(hh[!hhid %in% outlier], aes(costs_ha_ppp, yield_ha_kg)) +
  geom_smooth(aes(color=group, fill=group), size=.8, level=.9) +
  geom_point(alpha=.7, shape=20) +
  scale_x_continuous(labels=comma) +
  scale_y_continuous(labels=comma) +
  facet_wrap(~crop, scales="free") +
  #coord_cartesian(ylim=c(4000, 14000)) +
  labs(x="", y="",
    title="Production Frontier (Output vs. Input) - Guatemala",
    subtitle="Each point is a respondent. Shade shows 90% CI (kg vs. PPP$ / ha)") +
  theme_def(legend.position="right")


```



### Profitability

By gender:

```{r}

fmt <- function(x) c(Mean=comma(mean(x, na.rm=T)), SD=comma(sd(x, na.rm=T)))
ttt(margin_ha_ppp ~ group | gender, data=hh, render=fmt,
  caption="Mean Gross Profit Margin in Absolute Terms (PPP$ / ha) - Guatemala")

fmt <- function(x) c(Mean=percent(mean(x, na.rm=T)), SD=percent(sd(x, na.rm=T)))
ttt(margin_ha_sh ~ group | gender, data=hh, render=fmt,
  caption="Mean Gross Profit Margin in Relative Terms (% of variable input costs) - Guatemala")

```

By age group:

```{r}

fmt <- function(x) c(Mean=comma(mean(x, na.rm=T)), SD=comma(sd(x, na.rm=T)))
ttt(margin_ha_ppp ~ group | age, data=hh, render=fmt,
  caption="Mean Gross Profit Margin in Absolute Terms (PPP$ / ha) - Guatemala")

fmt <- function(x) c(Mean=percent(mean(x, na.rm=T)), SD=percent(sd(x, na.rm=T)))
ttt(margin_ha_sh ~ group | age, data=hh, render=fmt,
  caption="Mean Gross Profit Margin in Relative Terms (% of variable input costs) - Guatemala")

```

```{r}

ggplot(hh, aes(x=1:nrow(hh), color=group)) +
  geom_linerange(aes(ymin=costs_ha_ppp, ymax=sales_ha_ppp, linetype=gender), size=.6) +
  geom_point(aes(y=costs_ha_ppp), shape=20, size=1.4) +
  geom_point(aes(y=sales_ha_ppp), shape=17, size=1.4) +
  scale_y_continuous(labels=comma) +
  labs(x=NULL, y=NULL, color="", linetype="",
    title="Profit Margin (PPP$ / ha) - Guatemala",
    subtitle="Each bar is a respondent's gross profit margin") +
  theme_def(legend.position="right")

```

Farmers' gross profit margins by gender and across groups in both absolute terms and in relative terms as percentage of total costs per hectare.

```{r, out.width="50%", fig.width=2.5, fig.show="hold", fig.asp=1}

ggplot(hh, aes(gender, margin_ha_ppp, fill=gender)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=comma) +
  facet_wrap(~crop) +
  labs(x="", y="", fill="",
    title="Gross Profit Margin in Absolute Terms - Guatemala",
    subtitle="Stratified by gender (PPP$ / ha)") +
  theme_def(legend.position="none")

ggplot(hh, aes(gender, margin_ha_sh, fill=gender)) +
  geom_boxplot(alpha=.7) +
  scale_y_continuous(labels=percent) +
  facet_wrap(~crop) +
  labs(x="", y="", fill="",
    title="Gross Profit Margin in Relative Terms - Guatemala",
    subtitle="Stratified by gender (% of total costs)") +
  theme_def(legend.position="none")

```

```{r, out.width="50%", fig.width=2.5, fig.show="hold", fig.asp=1}

ggplot(hh, aes(group, margin_ha_ppp, fill=group)) +
  geom_boxplot(alpha=.7) +
  scale_x_discrete(labels=label_wrap(5)) +
  scale_y_continuous(labels=comma) +  
  labs(x="", y="", fill="",
    title="Gross Profit Margin in Absolute Terms - Guatemala",
    subtitle="Stratified by seed club (PPP$ / ha)") +
  theme_def(legend.position="none")

ggplot(hh, aes(group, margin_ha_sh, fill=group)) +
  geom_boxplot(alpha=.7) +
  scale_x_discrete(labels=label_wrap(5)) +  
  scale_y_continuous(labels=percent) +  
  labs(x="", y="", fill="",
    title="Gross Profit Margin in Relative Terms - Guatemala",
    subtitle="Stratified by seed club (% of total costs)") +
  theme_def(legend.position="none")

```

```{r save-gtm}

rm(tmp, x, y, i, fmt)
save.image("../tmp/data_gtm.RData")

```
